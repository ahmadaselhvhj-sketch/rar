<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ° PIT SLOT</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body {
            min-height: 100vh;
            background: linear-gradient(145deg, #1a0b2e, #2d1a44);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            padding: 10px;
        }
        .game-container {
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            padding: 25px 20px;
            width: 100%;
            max-width: 500px;
            border: 2px solid #9b4dff;
            box-shadow: 0 0 30px #9b4dff;
        }
        h1 { text-align: center; color: gold; margin-bottom: 20px; text-shadow: 0 0 15px gold; }
        .balance-box {
            background: #2c0b3a;
            border: 2px solid gold;
            border-radius: 50px;
            padding: 15px;
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 1.1em;
            gap: 10px;
            flex-wrap: wrap;
        }
        .choice-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .choice-btn {
            flex: 1;
            background: linear-gradient(135deg, #4a1d6d, #2c0b3a);
            border: 2px solid gold;
            color: white;
            padding: 12px;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: 0.3s;
        }
        .choice-btn.active {
            background: gold;
            color: #1a0b2e;
            font-weight: bold;
            box-shadow: 0 0 20px gold;
        }
        .slot-machine {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        .slot {
            width: 70px;
            height: 70px;
            background: #2c0b3a;
            border: 3px solid gold;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            color: gold;
            text-shadow: 0 0 15px gold;
            box-shadow: 0 0 20px #9b4dff;
        }
        .spin-btn {
            background: linear-gradient(135deg, #9b4dff, #6a1b9a);
            border: none;
            color: white;
            padding: 18px;
            width: 80%;
            margin: 15px auto;
            border-radius: 50px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid gold;
            box-shadow: 0 0 25px gold;
            display: block;
        }
        .spin-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }
        .result {
            text-align: center;
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
            color: gold;
            min-height: 40px;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>ğŸ° PIT SLOT</h1>
        <div class="balance-box">
            <span>ğŸ’° Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: <span id="main-balance">0</span></span>
            <span>ğŸ Ø§Ù„Ø¨ÙˆÙ†Øµ: <span id="bonus-balance">0</span></span>
        </div>
        <div class="choice-buttons" id="choice-section">
            <button class="choice-btn" id="play-main">ğŸ’ Ø§Ù„Ø¹Ø¨ Ø¨Ø§Ù„Ø±ØµÙŠØ¯</button>
            <button class="choice-btn" id="play-bonus">ğŸ Ø§Ù„Ø¹Ø¨ Ø¨Ø§Ù„Ø¨ÙˆÙ†Øµ</button>
        </div>
        <div id="game-section" class="hidden">
            <div class="slot-machine" id="slot-machine">
                <div class="slot" id="slot1">ğŸ’</div>
                <div class="slot" id="slot2">ğŸ’</div>
                <div class="slot" id="slot3">ğŸ’</div>
                <div class="slot" id="slot4">ğŸ’</div>
                <div class="slot" id="slot5">ğŸ’</div>
            </div>
            <button class="spin-btn" id="spin-btn">ğŸ”ƒ Ø¯ÙÙˆÙÙ‘Ø±</button>
            <div class="result" id="result"></div>
        </div>
    </div>

    <script>
        // ============================================================
        //  Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø«Ø§Ø¨ØªØ© - ØºÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Apps Script Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        // ============================================================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzU5mn0cRlvHvw5DNNGz0Gh9e8CGq_jGMpnNFyJdvdjQkbhScBrziH6-FCGov3bsVcTgA/exec';  // Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨ Ø¢Ø¨

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ user_id Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
        const urlParams = new URLSearchParams(window.location.search);
        const USER_ID = urlParams.get('user_id');
        if (!USER_ID) {
            alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…!');
            throw new Error('No user ID');
        }

        let userData = null;           // Ø³ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ { balance, bonus_balance }
        let selectedType = null;       // 'main' Ø£Ùˆ 'bonus'
        let spinning = false;

        // Ø¹Ù†Ø§ØµØ± HTML
        const mainBalanceSpan = document.getElementById('main-balance');
        const bonusBalanceSpan = document.getElementById('bonus-balance');
        const choiceSection = document.getElementById('choice-section');
        const gameSection = document.getElementById('game-section');
        const playMainBtn = document.getElementById('play-main');
        const playBonusBtn = document.getElementById('play-bonus');
        const spinBtn = document.getElementById('spin-btn');
        const resultDiv = document.getElementById('result');
        const slots = [
            document.getElementById('slot1'),
            document.getElementById('slot2'),
            document.getElementById('slot3'),
            document.getElementById('slot4'),
            document.getElementById('slot5')
        ];

        // ============================================================
        //  ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Apps Script (Ù…Ø¹ Ø¥Ù†Ø´Ø§Ø¦Ù‡ Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯)
        // ============================================================
        async function loadUserData() {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getUser', telegramId: USER_ID })
                });
                const data = await response.json();
                if (data.success) {
                    userData = data.user;
                    updateBalanceDisplay();
                } else {
                    alert('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + data.error);
                }
            } catch (e) {
                console.error(e);
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
            }
        }

        function updateBalanceDisplay() {
            if (userData) {
                mainBalanceSpan.innerText = userData.balance;
                bonusBalanceSpan.innerText = userData.bonus_balance;
            }
        }

        // ============================================================
        //  Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø±ØµÙŠØ¯
        // ============================================================
        playMainBtn.addEventListener('click', () => {
            if (userData.balance < 1000) {
                alert('âš ï¸ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ø§ ÙŠÙƒÙÙŠ (ÙŠØ­ØªØ§Ø¬ 1000)');
                return;
            }
            selectedType = 'main';
            choiceSection.classList.add('hidden');
            gameSection.classList.remove('hidden');
        });

        playBonusBtn.addEventListener('click', () => {
            if (userData.bonus_balance < 1000) {
                alert('âš ï¸ Ø±ØµÙŠØ¯ Ø§Ù„Ø¨ÙˆÙ†Øµ Ù„Ø§ ÙŠÙƒÙÙŠ (ÙŠØ­ØªØ§Ø¬ 1000)');
                return;
            }
            selectedType = 'bonus';
            choiceSection.classList.add('hidden');
            gameSection.classList.remove('hidden');
        });

        // ============================================================
        //  Ø¯ÙˆØ±Ø© Ø§Ù„Ù„Ø¹Ø¨
        // ============================================================
        spinBtn.addEventListener('click', async () => {
            if (spinning) return;
            spinning = true;
            spinBtn.disabled = true;
            resultDiv.innerText = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¯ÙˆÙŠØ±...';

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'spin',
                        telegramId: USER_ID,
                        balanceType: selectedType   // 'main' Ø£Ùˆ 'bonus'
                    })
                });
                const data = await response.json();
                if (data.success) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù…ÙˆØ²
                    for (let i = 0; i < 5; i++) {
                        slots[i].innerText = data.symbols[i];
                    }
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
                    userData = data.updatedUser;
                    updateBalanceDisplay();
                    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙÙˆØ²
                    if (data.winAmount > 0) {
                        resultDiv.innerText = `ğŸ‰ ÙØ²Øª Ø¨ ${data.winAmount} !`;
                    } else {
                        resultDiv.innerText = 'ğŸ˜¢ Ù„Ø§ ÙÙˆØ² Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø©';
                    }
                } else {
                    alert('âŒ Ø®Ø·Ø£: ' + data.error);
                    resultDiv.innerText = '';
                }
            } catch (e) {
                console.error(e);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                resultDiv.innerText = '';
            } finally {
                spinning = false;
                spinBtn.disabled = false;
                // Ø¥Ø°Ø§ Ø£ØµØ¨Ø­ Ø§Ù„Ø±ØµÙŠØ¯ Ø£Ù‚Ù„ Ù…Ù† 1000ØŒ Ù†Ø¹ÙŠØ¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø±ØµÙŠØ¯
                if (selectedType === 'main' && userData.balance < 1000) {
                    alert('âš ï¸ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù†ÙØ¯ØŒ Ø§Ø®ØªØ± Ù†ÙˆØ¹Ø§Ù‹ Ø¢Ø®Ø±');
                    choiceSection.classList.remove('hidden');
                    gameSection.classList.add('hidden');
                    selectedType = null;
                } else if (selectedType === 'bonus' && userData.bonus_balance < 1000) {
                    alert('âš ï¸ Ø±ØµÙŠØ¯ Ø§Ù„Ø¨ÙˆÙ†Øµ Ù†ÙØ¯ØŒ Ø§Ø®ØªØ± Ù†ÙˆØ¹Ø§Ù‹ Ø¢Ø®Ø±');
                    choiceSection.classList.remove('hidden');
                    gameSection.classList.add('hidden');
                    selectedType = null;
                }
            }
        });

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        loadUserData();
    </script>
</body>
</html>
